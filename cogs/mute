import discord
from discord.ext import commands
import asyncio
import datetime
import json

with open('config.json', 'r') as file:
	config = json.load(file)

with open('user_mute.json', 'r') as file:
	users = json.load(file)

class User(commands.Cog):
    def __init__(self, client):
        self.client = client

    @commands.command()
    @commands.has_permissions(administrator = True)
    async def mute(self, ctx, member: discord.Member, time = "*", *, reason = "–Ω–µ —É–∫–∞–∑–∞–Ω–∞"):
        await ctx.message.channel.purge(limit = 1)
        author = ctx.message.author
        guild = ctx.guild
        try:
            if users['mutes'][f'{member.id}']['time'] > 0:
                embed = discord.Embed(description = f"**{member.mention} —É–∂–µ –∏–º–µ–µ—Ç –º—É—Ç!**\n–ü—Ä–∏—á–∏–Ω–∞: `{users['mutes'][f'{member.id}']['reason']}`\n–û—Å—Ç–∞–ª–æ—Å—å: `{datetime.timedelta(seconds=users['mutes'][f'{member.id}']['time'])}`", colour=discord.Colour.light_gray())
                await ctx.send(embed = embed)
            if users['mutes'][f'{member.id}']['time'] < 0:
                embed = discord.Embed(description = f"{member.mention} —É–∂–µ –∏–º–µ–µ—Ç –ø–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω—ã–π –º—É—Ç!", colour=discord.Colour.light_gray())
                await ctx.send(embed = embed)
            if users['mutes'][f'{member.id}']['time'] == 0:
                if time[-1] == "s":
                    sec = int(time[:-1])
                elif time[-1] == "m":
                    sec = int(time[:-1])*60
                elif time[-1] == "h":
                    sec = int(time[:-1])*60*60
                elif time[-1] == "d":
                    sec = int(time[:-1])*60*60*24
                elif time[-1] == "1" or time[-1] == "2" or time[-1] == "3" or time[-1] == "4" or time[-1] == "5" or time[-1] == "6" or time[-1] == "7" or time[-1] == "8" or time[-1] == "9" or time[-1] == "0":
                    sec = 0
                elif time == "*":
                    sec = -1
                users['mutes'][f'{member.id}']['time'] = sec
                with open('user_mute.json', 'w') as file:
                    json.dump(users, file, indent=2)

                for role in guild.roles:
                    if role.id == config['mute']['role']:
                        if users['mutes'][f'{member.id}']['time'] == 0:
                            await ctx.send(f'–û—à–∏–±–∫–∞, —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ–º–∞–Ω–¥—ã:\n`{config["settings"]["prefix"]}mute @member#1234 1d/2h/30m/40m –ø—Ä–∏—á–∏–Ω–∞`')
                        elif users['mutes'][f'{member.id}']['time'] < 0:
                            await member.add_roles(role)
                            users['mutes'][f'{member.id}']['mute'] = True
                            with open('user_mute.json', 'w') as file:
                                json.dump(users, file, indent=2)
                            embed = discord.Embed(description = f"‚úÖ {member.mention}–ø–æ–ª—É—á–∏–ª –º—É—Ç –Ω–∞–≤—Å–µ–≥–¥–∞!", colour=discord.Colour.light_gray())
                            embed.set_footer(text = f"–û—Å—É–¥–∏–ª: {author}")
                            embed = discord.Embed(description=f"{member.mention}, –í—ã –ø–æ–ª—É—á–∏–ª–∏ –º—É—Ç –Ω–∞–≤—Å–µ–≥–¥–∞!", colour=discord.Colour.light_gray())
                            await member.send(embed = embed)
                            await ctx.send(embed = embed)
                        elif users['mutes'][f'{member.id}']['time'] > 0:
                            await member.add_roles(role)
                            users['mutes'][f'{member.id}']['mute'] = True
                            users['mutes'][f'{member.id}']['reason'] = reason
                            with open('user_mute.json', 'w') as file:
                                json.dump(users, file, indent=2)
                            embed = discord.Embed(description = f"‚úÖ {member.mention}–ø–æ–ª—É—á–∏–ª –º—É—Ç!\n–ü—Ä–∏—á–∏–Ω–∞: `{reason}`\n–ù–∞: `{datetime.timedelta(seconds=users['mutes'][f'{member.id}']['time'])}`", colour=discord.Colour.light_gray())
                            embed.set_footer(text = f"–û—Å—É–¥–∏–ª: {author}")
                            await ctx.send(embed = embed)
                            embed = discord.Embed(description=f"{member.mention}, –í—ã –ø–æ–ª—É—á–∏–ª–∏ –º—É—Ç!\n–ü—Ä–∏—á–∏–Ω–∞: `{users['mutes'][f'{member.id}']['reason']}`\n–û—Å—Ç–∞–ª–æ—Å—å: `{datetime.timedelta(seconds=users['mutes'][f'{member.id}']['time'])}`", colour=discord.Colour.light_gray())
                            await member.send(embed = embed)
                            while users['mutes'][f'{member.id}']['time'] > 0:
                                await asyncio.sleep(1)
                                users['mutes'][f'{member.id}']['time'] -= 1
                                with open('user_mute.json', 'w') as file:
                                    json.dump(users, file, indent=2)
                            if users['mutes'][f'{member.id}']['mute'] == True:
                                users['mutes'][f'{member.id}']['mute'] = False
                                with open('user_mute.json', 'w') as file:
                                    json.dump(users, file, indent=2)
                                await member.remove_roles(role)        
                                embed = discord.Embed(description=f"{member.mention}, —Å –í–∞—Å —Å–Ω—è–ª–∏ –º—É—Ç!\n–ü—Ä–æ—Å–∏–º –±–æ–ª—å—à–µ –Ω–µ –Ω–∞—Ä—É—à–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞ —Å–µ—Ä–≤–µ—Ä–∞", colour=discord.Colour.light_gray())
                                await member.send(embed = embed)
                            elif users['mutes'][f'{member.id}']['mute'] == False:
                                return
        except:
            users['mutes'][f'{member.id}'] = {"mute": False,"reason": 0,"time": 0}
            with open('user_mute.json', 'w') as file:
                json.dump(users, file, indent=2)
            if time[-1] == "s":
                sec = int(time[:-1])
            elif time[-1] == "m":
                sec = int(time[:-1])*60
            elif time[-1] == "h":
                sec = int(time[:-1])*60*60
            elif time[-1] == "d":
                sec = int(time[:-1])*60*60*24
            elif time[-1] == "1" or time[-1] == "2" or time[-1] == "3" or time[-1] == "4" or time[-1] == "5" or time[-1] == "6" or time[-1] == "7" or time[-1] == "8" or time[-1] == "9" or time[-1] == "0":
                sec = 0
            elif time == "*":
                sec = -1
            users['mutes'][f'{member.id}']['time'] = sec
            with open('user_mute.json', 'w') as file:
                json.dump(users, file, indent=2)

            for role in guild.roles:
                if role.id == config['mute']['role']:
                    if users['mutes'][f'{member.id}']['time'] == 0:
                        await ctx.send(f'–û—à–∏–±–∫–∞, —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ–º–∞–Ω–¥—ã:\n`{config["settings"]["prefix"]}mute @member#1234 1d/2h/30m/40m –ø—Ä–∏—á–∏–Ω–∞`')
                    elif users['mutes'][f'{member.id}']['time'] < 0:
                        await member.add_roles(role)
                        users['mutes'][f'{member.id}']['mute'] = True
                        with open('user_mute.json', 'w') as file:
                            json.dump(users, file, indent=2)
                        embed = discord.Embed(description = f"‚úÖ {member.mention}–ø–æ–ª—É—á–∏–ª –º—É—Ç –Ω–∞–≤—Å–µ–≥–¥–∞!", colour=discord.Colour.light_gray())
                        embed.set_footer(text = f"–û—Å—É–¥–∏–ª: {author}")
                        embed = discord.Embed(description=f"{member.mention}, –í—ã –ø–æ–ª—É—á–∏–ª–∏ –º—É—Ç –Ω–∞–≤—Å–µ–≥–¥–∞!", colour=discord.Colour.light_gray())
                        await member.send(embed = embed)
                        await ctx.send(embed = embed)
                    elif users['mutes'][f'{member.id}']['time'] > 0:
                        await member.add_roles(role)
                        users['mutes'][f'{member.id}']['mute'] = True
                        users['mutes'][f'{member.id}']['reason'] = reason
                        with open('user_mute.json', 'w') as file:
                            json.dump(users, file, indent=2)
                        embed = discord.Embed(description = f"‚úÖ {member.mention}–ø–æ–ª—É—á–∏–ª –º—É—Ç!\n–ü—Ä–∏—á–∏–Ω–∞: `{reason}`\n–ù–∞: `{datetime.timedelta(seconds=users['mutes'][f'{member.id}']['time'])}`", colour=discord.Colour.light_gray())
                        embed.set_footer(text = f"–û—Å—É–¥–∏–ª: {author}")
                        await ctx.send(embed = embed)
                        embed = discord.Embed(description=f"{member.mention}, –í—ã –ø–æ–ª—É—á–∏–ª–∏ –º—É—Ç!\n–ü—Ä–∏—á–∏–Ω–∞: `{users['mutes'][f'{member.id}']['reason']}`\n–û—Å—Ç–∞–ª–æ—Å—å: `{datetime.timedelta(seconds=users['mutes'][f'{member.id}']['time'])}`", colour=discord.Colour.light_gray())
                        await member.send(embed = embed)
                        while users['mutes'][f'{member.id}']['time'] > 0:
                            await asyncio.sleep(1)
                            users['mutes'][f'{member.id}']['time'] -= 1
                            with open('user_mute.json', 'w') as file:
                                json.dump(users, file, indent=2)
                        if users['mutes'][f'{member.id}']['mute'] == True:
                            users['mutes'][f'{member.id}']['mute'] = False
                            with open('user_mute.json', 'w') as file:
                                json.dump(users, file, indent=2)
                            await member.remove_roles(role)        
                            embed = discord.Embed(description=f"{member.mention}, —Å –í–∞—Å —Å–Ω—è–ª–∏ –º—É—Ç!\n–ü—Ä–æ—Å–∏–º –±–æ–ª—å—à–µ –Ω–µ –Ω–∞—Ä—É—à–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞ —Å–µ—Ä–≤–µ—Ä–∞üíñ", colour=discord.Colour.light_gray())
                            await member.send(embed = embed)
                        elif users['mutes'][f'{member.id}']['mute'] == False:
                            return
    @commands.Cog.listener()
    async def on_message(self, message):
        content = message.content
        if '<@!227117061011144704>' in content:
            await message.add_reaction("üíñ")
    @commands.command()
    @commands.has_permissions(administrator = True)
    async def unmute(self, ctx, member: discord.Member):
        await ctx.message.channel.purge(limit = 1)
        guild = ctx.guild

        for role in guild.roles:
            if role.id == config['mute']['role']:
                if users['mutes'][f'{member.id}']['mute'] == True:
                    await member.remove_roles(role)
                    users['mutes'][f'{member.id}']['mute'] = False
                    users['mutes'][f'{member.id}']['time'] = 0
                    with open('user_mute.json', 'w') as file:
                        json.dump(users, file, indent=2)
                    await asyncio.sleep(2)
                    users['mutes'][f'{member.id}']['time'] = 0
                    users['mutes'][f'{member.id}']['reason'] = 0
                    with open('user_mute.json', 'w') as file:
                        json.dump(users, file, indent=2)
                    embed = discord.Embed(description = f"–° –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {member.mention} —Å–Ω—è—Ç –º—É—Ç!", colour=discord.Colour.light_gray())
                    await ctx.send(embed = embed)                   
                    embed = discord.Embed(description = f"{member.mention}, —Å –í–∞—Å —Å–Ω—è–ª–∏ –º—É—Ç!\n–ü—Ä–æ—Å–∏–º –±–æ–ª—å—à–µ –Ω–µ –Ω–∞—Ä—É—à–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞ —Å–µ—Ä–≤–µ—Ä–∞üíñ", colour=discord.Colour.light_gray())
                    await member.send(embed = embed)

                elif users['mutes'][f'{member.id}']['mute'] == False:
                    embed = discord.Embed(description = f"{member.mention} –Ω–µ –≤ –º—É—Ç–µ!", colour=discord.Colour.light_gray())
                    await ctx.send(embed = embed)

def setup(client):
    client.add_cog(User(client))